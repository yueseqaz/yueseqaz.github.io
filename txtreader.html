<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT 文件阅读器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            transition: all 0.3s ease;
            position: relative;
        }

        .fullscreen-mode {
            padding: 0;
            background-color: rgba(244, 244, 244, 0.9);
        }

        .chapter-list {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px 0;
        }

        .chapter-list.show {
            transform: translateX(0);
        }

        .chapter-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .chapter-item:hover {
            background-color: #f0f0f0;
        }

        .chapter-item.active {
            background-color: #e6f3ff;
            border-left: 4px solid #007aff;
        }

        .controls-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .controls-container.collapsed {
            transform: translateX(calc(100% - 40px));
        }

        .toggle-controls {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #007aff;
            color: white;
            border: none;
            width: 20px;
            height: 40px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
        }

        .controls-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-left: 20px;
        }

        .file-input {
            font-size: 16px;
            padding: 10px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            width: 200px;
        }

        .content-container {
            width: 100%;
            height: calc(100vh - 80px);
            padding: 40px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin: 0;
            transition: all 0.3s ease;
            padding-bottom: 100px;
        }

        .content-container.fullscreen {
            padding: 60px 15% 100px 15% !important;
            font-size: 20px;
            line-height: 2;
        }

        .pagination {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-width: 100px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn:disabled {
            background-color: #d3d3d3;
        }

        .btn.red {
            background-color: #ff5b5b;
        }

        .btn.red:hover {
            background-color: #e14c4c;
        }

        .toggle-chapters-btn {
            position: fixed;
            left: 20px;
            top: 20px;
            z-index: 1000;
            padding: 10px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-info {
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .toggle-chapters-btn {
            background-color: #ff5b5b;
        }
    </style>
</head>
<body>
    <div class="chapter-list" id="chapterList">
        <button id="closeChapters" class="btn" style="width: 100%; margin-bottom: 10px;">收纳</button>
    </div>

    <div class="controls-container" id="controls">
        <button class="toggle-controls" id="toggleControls">⇄</button>
        <div class="controls-content">
            <label for="fileInput">TXT文件:</label>
            <input type="file" id="fileInput" class="file-input" accept=".txt" placeholder="请上传TXT文件">
            <label for="bgImageInput">背景图片:</label>
            <input type="file" id="bgImageInput" class="file-input" accept="image/*" placeholder="请上传图片">
            <div class="btn-group">
                <button id="fullscreenBtn" class="btn">退出全屏</button>
                <button id="generateChapters" class="btn red">更新目录</button>
                <button id="collapseChapters" class="btn">收纳目录</button>
            </div>
        </div>
    </div>

    <div class="content-container fullscreen" id="fileContent" style="animation: fadeIn 1s ease-in forwards;">
        <p style="font-size: 24px; color: #555; margin-bottom: 10px;">这是一个简单的 TXT 文件阅读器</p>
        <p style="font-size: 24px; color: #555; margin-bottom: 10px;">支持全屏模式、翻页、章节目录等功能</p>
        <p style="font-size: 24px; color: #555; margin-bottom: 10px;">欢迎使用!</p>
        <p style="font-size: 24px; color: #555; margin-bottom: 10px;">使用方法：上传TXT文件，以及图片文件，点击“更新目录”按钮即可，M键收纳目录</p>
    </div>

    <style>
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: scale(.5);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

    <div class="pagination">
        <button id="prevPage" class="btn" disabled>上一页</button>
        <div class="page-info">
            第 <span id="currentPageNum">0</span> / <span id="totalPages">0</span> 页
        </div>
        <button id="nextPage" class="btn" disabled>下一页</button>
    </div>

    <script>
        const linesPerPage = 20;
        let fileContent = '';
        let currentPage = 0;
        let fileLines = [];
        let chapters = [];
        let isFullscreen = true;
        let currentChapter = 0;
        
        // 控制面板折叠/展开
        document.getElementById('toggleControls').addEventListener('click', function() {
            document.getElementById('controls').classList.toggle('collapsed');
            this.textContent = document.getElementById('controls').classList.contains('collapsed') ? '⇢' : '⇄';
        });

        // 章节目录切换
        document.getElementById('toggleChapters').addEventListener('click', function() {
            document.getElementById('chapterList').classList.toggle('show');
        });

        // 收纳按钮处理
        document.getElementById('closeChapters').addEventListener('click', function() {
            document.getElementById('chapterList').classList.remove('show');
        });
        
        // 文件上传处理
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileContent = e.target.result;
                    fileLines = fileContent.split('\n');
                    chapters = [];
                    currentPage = 0;

                    renderPage();
                    updatePageInfo();
                    document.getElementById('generateChapters').style.display = 'inline-block';
                };
                reader.readAsText(file);
            } else {
                document.getElementById('fileContent').textContent = '请上传一个有效的 TXT 文件。';
            }
        });

        // 背景图片上传处理
        document.getElementById('bgImageInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        });

        // 更新页码信息
        function updatePageInfo() {
            const totalPages = Math.ceil(fileLines.length / linesPerPage);
            document.getElementById('currentPageNum').textContent = currentPage + 1;
            document.getElementById('totalPages').textContent = totalPages;
        }

        // 全屏模式切换
        document.getElementById('fullscreenBtn').addEventListener('click', function() {
            isFullscreen = !isFullscreen;
            const contentContainer = document.getElementById('fileContent');
            
            if (isFullscreen) {
                document.body.classList.add('fullscreen-mode');
                contentContainer.classList.add('fullscreen');
                this.textContent = '退出全屏';
            } else {
                document.body.classList.remove('fullscreen-mode');
                contentContainer.classList.remove('fullscreen');
                this.textContent = '全屏阅读';
            }
        });

        // 生成章节目录
        document.getElementById('generateChapters').addEventListener('click', function() {
            chapters = [];
            let chapterStart = 0;
            
            fileLines.forEach((line, index) => {
                if (line.trim().match(/^第[零一二三四五六七八九十百千万\d]+章[^《》()]*$/)) {
                    if (chapterStart < index) {
                        chapters.push({
                            title: fileLines[chapterStart].trim(),
                            content: fileLines.slice(chapterStart, index).join('\n'),
                            startLine: chapterStart
                        });
                    }
                    chapterStart = index;
                }
            });
            
            // 添加最后一章
            if (chapterStart < fileLines.length) {
                chapters.push({
                    title: fileLines[chapterStart].trim(),
                    content: fileLines.slice(chapterStart).join('\n'),
                    startLine: chapterStart
                });
            }

            renderChapterList();
            document.getElementById('chapterList').classList.add('show');
        });

        // 渲染章节目录
        function renderChapterList() {
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = '<h2 style="padding: 0 20px;">目录</h2>';
            
            chapters.forEach((chapter, index) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-item';
                chapterDiv.textContent = chapter.title;
                chapterDiv.addEventListener('click', () => {
                    currentPage = Math.floor(chapter.startLine / linesPerPage);
                    renderPage();
                    updateActiveChapter(index);
                });
                chapterList.appendChild(chapterDiv);
            });
        }

        // 更新当前章节高亮
        function updateActiveChapter(index) {
            const items = document.querySelectorAll('.chapter-item');
            items.forEach(item => item.classList.remove('active'));
            if (items[index]) {
                items[index].classList.add('active');
            }
        }

        // 渲染页面内容
        function renderPage() {
    const startLine = currentPage * linesPerPage;
    const endLine = startLine + linesPerPage;
    const pageLines = fileLines.slice(startLine, endLine);
    
    const contentContainer = document.getElementById('fileContent');
    contentContainer.textContent = pageLines.join('\n');
    document.getElementById('prevPage').disabled = currentPage === 0;
    document.getElementById('nextPage').disabled = currentPage * linesPerPage >= fileLines.length;
    updatePageInfo();

    // Scroll to the top of the content container
    contentContainer.scrollTop = 0;

    // Update current chapter
    if (chapters.length > 0) {
        const currentLine = startLine;
        const currentChapterIndex = chapters.findIndex((chapter, index) => {
            const nextChapter = chapters[index + 1];
            return chapter.startLine <= currentLine && 
                   (!nextChapter || nextChapter.startLine > currentLine);
        });
        if (currentChapterIndex !== -1) {
            updateActiveChapter(currentChapterIndex);
        }
    }
}

        // 翻页处理
        document.getElementById('prevPage').addEventListener('click', function() {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
            }
        });

        document.getElementById('nextPage').addEventListener('click', function() {
            if ((currentPage + 1) * linesPerPage < fileLines.length) {
                currentPage++;
                renderPage();
            }
        });

        // 键盘快捷键
        document.getElementById('collapseChapters').addEventListener('click', function() {
        document.getElementById('chapterList').classList.toggle('show');
    });

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            document.getElementById('prevPage').click();
        } else if (e.key === 'ArrowRight') {
            document.getElementById('nextPage').click();
        } else if (e.key === 'f') {
            document.getElementById('fullscreenBtn').click();
        } else if (e.key === 'h') {
            document.getElementById('toggleControls').click();
        } else if (e.key === 'm') {
            // "m" 键收纳/展开目录
            document.getElementById('chapterList').classList.toggle('show');
        }
    });

        // 初始化：折叠控制面板
        document.getElementById('toggleControls').click();
        // Add swipe event listeners
document.addEventListener('touchstart', handleTouchStart, false);
document.addEventListener('touchmove', handleTouchMove, false);

let xDown = null;
let yDown = null;

function handleTouchStart(evt) {
    const firstTouch = evt.touches[0];
    xDown = firstTouch.clientX;
    yDown = firstTouch.clientY;
}

function handleTouchMove(evt) {
    if (!xDown || !yDown) {
        return;
    }

    const xUp = evt.touches[0].clientX;
    const yUp = evt.touches[0].clientY;

    const xDiff = xDown - xUp;
    const yDiff = yDown - yUp;

    if (Math.abs(xDiff) > Math.abs(yDiff)) {
        if (xDiff > 0) {
            // Left swipe
            document.getElementById('nextPage').click();
        } else {
            // Right swipe
            document.getElementById('prevPage').click();
        }
    }
    xDown = null;
    yDown = null;
}
// Save the current page in localStorage
function saveCurrentPage() {
    localStorage.setItem('currentPage', currentPage);
}

// Load the current page from localStorage
function loadCurrentPage() {
    const savedPage = localStorage.getItem('currentPage');
    if (savedPage !== null) {
        currentPage = parseInt(savedPage, 10);
        renderPage();
    }
}

// Call saveCurrentPage when page changes
document.getElementById('prevPage').addEventListener('click', saveCurrentPage);
document.getElementById('nextPage').addEventListener('click', saveCurrentPage);

// Load the saved page on load
window.addEventListener('load', loadCurrentPage);
    </script>
</body>
</html>
