<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT 文件阅读器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            transition: all 0.3s ease;
            position: relative;
        }

        .fullscreen-mode {
            padding: 0;
            background-color: rgba(244, 244, 244, 0.9);
        }

        .chapter-list {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: min(80vw, 300px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px 0;
            -webkit-overflow-scrolling: touch;
        }

        .chapter-list.show {
            transform: translateX(0);
        }

        .chapter-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #333;
            font-size: clamp(14px, 2vw, 16px);
            border-bottom: 1px solid #eee;
            word-break: break-all;
        }

        .chapter-item:hover {
            background-color: #f0f0f0;
        }

        .chapter-item.active {
            background-color: #e6f3ff;
            border-left: 4px solid #007aff;
        }

        .controls-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
            max-width: 90vw;
        }

        .controls-container.collapsed {
            transform: translateX(calc(100% - 40px));
        }

        .toggle-controls {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #007aff;
            color: white;
            border: none;
            width: 24px;
            height: 48px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .controls-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-left: 24px;
        }

        .file-input {
            font-size: clamp(14px, 2vw, 16px);
            padding: 10px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }

        .content-container {
            width: 100%;
            height: calc(100vh - 80px);
            padding: clamp(20px, 5vw, 40px);
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.95);
            white-space: pre-wrap;
            overflow-y: auto;
            font-size: clamp(16px, 2.5vw, 18px);
            line-height: 1.8;
            color: #333;
            margin: 0;
            transition: all 0.3s ease;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .content-container.fullscreen {
            padding: 60px max(15%, 20px) 100px max(15%, 20px) !important;
            font-size: clamp(18px, 3vw, 20px);
            line-height: 2;
        }

        .pagination {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-width: 100px;
            font-size: clamp(14px, 2vw, 16px);
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn:disabled {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }

        .btn.red {
            background-color: #ff5b5b;
        }

        .btn.red:hover {
            background-color: #e14c4c;
        }

        .page-info {
            display: flex;
            align-items: center;
            font-size: clamp(14px, 2vw, 16px);
            color: #666;
            white-space: nowrap;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .controls-container {
                top: 10px;
                right: 10px;
            }

            .btn-group {
                justify-content: center;
            }

            .pagination {
                padding: 10px;
            }

            .btn {
                padding: 8px 16px;
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            .controls-content {
                gap: 8px;
            }

            .pagination {
                gap: 10px;
            }
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: scale(.98);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .welcome-text {
            font-size: clamp(18px, 3vw, 24px);
            color: #555;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="chapter-list" id="chapterList">
        <button id="closeChapters" class="btn" style="width: calc(100% - 40px); margin: 0 20px 20px 20px;">收纳</button>
    </div>

    <div class="controls-container" id="controls">
        <button class="toggle-controls" id="toggleControls">⇄</button>
        <div class="controls-content">
            <label for="fileInput">TXT文件:</label>
            <input type="file" id="fileInput" class="file-input" accept=".txt">
            <label for="bgImageInput">背景图片:</label>
            <input type="file" id="bgImageInput" class="file-input" accept="image/*">
            <div class="btn-group">
                <button id="fullscreenBtn" class="btn">退出全屏</button>
                <button id="generateChapters" class="btn red">更新目录</button>
                <button id="collapseChapters" class="btn">收纳目录</button>
            </div>
        </div>
    </div>

    <div class="content-container fullscreen" id="fileContent">
        <p class="welcome-text">这是一个简单的 TXT 文件阅读器</p>
        <p class="welcome-text">支持全屏模式、翻页、章节目录等功能</p>
        <p class="welcome-text">欢迎使用!</p>
        <p class="welcome-text">使用方法：上传TXT文件，以及图片文件，点击"更新目录"按钮即可</p>
        <p class="welcome-text">快捷键：← → 翻页，F 全屏，H 隐藏控制栏，M 目录</p>
    </div>

    <div class="pagination">
        <button id="prevPage" class="btn" disabled>上一页</button>
        <div class="page-info">
            第 <span id="currentPageNum">0</span> / <span id="totalPages">0</span> 页
        </div>
        <button id="nextPage" class="btn" disabled>下一页</button>
    </div>

    <script>
        const linesPerPage = Math.floor(window.innerHeight / 30);
        let fileContent = '';
        let currentPage = 0;
        let fileLines = [];
        let chapters = [];
        let isFullscreen = true;
        let currentChapter = 0;
        
        // 从localStorage加载上次阅读位置和背景图片
        function loadSavedState() {
            const savedPage = localStorage.getItem('currentPage');
            const savedBgImage = localStorage.getItem('backgroundImage');
            
            if (savedPage !== null) {
                currentPage = parseInt(savedPage, 10);
            }
            
            if (savedBgImage) {
                document.body.style.backgroundImage = savedBgImage;
            }
        }

        // 保存当前状态
        function saveCurrentState() {
            localStorage.setItem('currentPage', currentPage);
            localStorage.setItem('backgroundImage', document.body.style.backgroundImage);
        }

        // 控制面板折叠/展开
        document.getElementById('toggleControls').addEventListener('click', function() {
            document.getElementById('controls').classList.toggle('collapsed');
            this.textContent = document.getElementById('controls').classList.contains('collapsed') ? '⇢' : '⇄';
        });

        // 章节目录相关
        document.getElementById('closeChapters').addEventListener('click', function() {
            document.getElementById('chapterList').classList.remove('show');
        });

        document.getElementById('collapseChapters').addEventListener('click', function() {
            document.getElementById('chapterList').classList.toggle('show');
        });

        // 文件上传处理
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileContent = e.target.result;
                    fileLines = fileContent.split('\n');
                    chapters = [];
                    currentPage = 0;
                    renderPage();
                    updatePageInfo();
                    document.getElementById('generateChapters').style.display = 'inline-block';
                    saveCurrentState();
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                alert('请上传有效的TXT文件');
            }
        });

        // 背景图片上传处理
        document.getElementById('bgImageInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    saveCurrentState();
                };
                reader.readAsDataURL(file);
            }
        });

        // 页码信息更新
        function updatePageInfo() {
            const totalPages = Math.ceil(fileLines.length / linesPerPage);
            document.getElementById('currentPageNum').textContent = currentPage + 1;
            document.getElementById('totalPages').textContent = totalPages;
        }

        // 全屏模式切换
        document.getElementById('fullscreenBtn').addEventListener('click', function() {
            isFullscreen = !isFullscreen;
            const contentContainer = document.getElementById('fileContent');
            
            if (isFullscreen) {
                document.body.classList.add('fullscreen-mode');
                contentContainer.classList.add('fullscreen');
                this.textContent = '退出全屏';
            } else {
                document.body.classList.remove('fullscreen-mode');
                contentContainer.classList.remove('fullscreen');
                this.textContent = '全屏阅读';
            }
        });

        // 生成章节目录
        document.getElementById('generateChapters').addEventListener('click', function() {
            chapters = [];
            let chapterStart = 0;
            
            fileLines.forEach((line, index) => {
                if (line.trim().match(/^第[零一二三四五六七八九十百千万\d]+章[^《》()]*$/)) {
                    if (chapterStart < index) {
                        chapters.push({
                            title: fileLines[chapterStart].trim(),
                            content: fileLines.slice(chapterStart, index).join('\n'),
                            startLine: chapterStart
                        });
                    }
                    chapterStart = index;
                }
            });
            
            if (chapterStart < fileLines.length) {
                chapters.push({
                    title: fileLines[chapterStart].trim(),
                    content: fileLines.slice(chapterStart).join('\n'),
                    startLine: chapterStart
                });
            }

            renderChapterList();
            document.getElementById('chapterList').classList.add('show');
        });

        // 渲染章节目录
        function renderChapterList() {
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = '<button id="closeChapters" class="btn" style="width: calc(100% - 40px); margin: 0 20px 20px 20px;">收纳</button>';
            
            chapters.forEach((chapter, index) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-item';
                chapterDiv.textContent = chapter.title;
                chapterDiv.addEventListener('click', () => {
                    currentPage = Math.floor(chapter.startLine / lines</antArtifact>