<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>IPå®šä½è¿½è¸ªå™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="å®æ—¶æŸ¥çœ‹æ‚¨çš„å…¬ç½‘IPåœ°å€ã€åœ°ç†ä½ç½®å’Œç½‘ç»œæœåŠ¡æä¾›å•†ä¿¡æ¯"/>
  <meta name="keywords" content="IPå®šä½,åœ°ç†ä½ç½®,ç½‘ç»œè¿½è¸ª,IPæŸ¥è¯¢"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .header-content {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .info-container {
      background: var(--card-bg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      border-bottom: 1px solid var(--border-color);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .info-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .info-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), #60a5fa);
    }

    .info-card h3 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-value {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--primary-color);
      word-break: break-all;
    }

    .info-details {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .loading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .status-success { background: var(--success-color); }
    .status-warning { background: var(--warning-color); }
    .status-error { background: var(--error-color); }

    #map {
      flex: 1;
      min-height: 400px;
      border-top: 1px solid var(--border-color);
    }

    .map-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.75rem;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      font-size: 1rem;
    }

    .map-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .info-container {
        padding: 1rem;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .info-card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1><i class="fas fa-globe-americas"></i> æˆ‘çš„ç½‘ç»œè¶³è¿¹</h1>
      <p>å®æ—¶è¿½è¸ªæ‚¨çš„ç½‘ç»œä½ç½®å’Œç‰©ç†ä½ç½®ä¿¡æ¯</p>
    </div>
  </header>

  <div class="info-container">
    <div class="info-grid">
      <div class="info-card">
        <h3><i class="fas fa-network-wired"></i> å…¬ç½‘IPåœ°å€</h3>
        <div class="info-value" id="ip">
          <div class="loading">
            <div class="spinner"></div>
            <span>æ­£åœ¨è·å–IPåœ°å€...</span>
          </div>
        </div>
        <div class="info-details" id="ip-details">æ­£åœ¨æŸ¥è¯¢ç½‘ç»œæœåŠ¡æä¾›å•†ä¿¡æ¯...</div>
      </div>

      <div class="info-card">
        <h3><i class="fas fa-map-marker-alt"></i> IPå½’å±åœ°</h3>
        <div class="info-value" id="ip-location">
          <div class="loading">
            <div class="spinner"></div>
            <span>æ­£åœ¨å®šä½...</span>
          </div>
        </div>
        <div class="info-details" id="ip-location-details">æ­£åœ¨æŸ¥è¯¢è¯¦ç»†ä½ç½®ä¿¡æ¯...</div>
      </div>

      <div class="info-card">
        <h3><i class="fas fa-crosshairs"></i> å®é™…ç‰©ç†ä½ç½®</h3>
        <div class="info-value" id="geo-location">
          <div class="loading">
            <div class="spinner"></div>
            <span>ç­‰å¾…ç”¨æˆ·æˆæƒ...</span>
          </div>
        </div>
        <div class="info-details" id="geo-location-details">éœ€è¦æ‚¨çš„æˆæƒæ‰èƒ½è·å–ç²¾ç¡®ä½ç½®</div>
      </div>
    </div>
  </div>

  <div id="map"></div>
  
  <div class="map-controls">
    <button class="map-btn" id="center-ip" title="å±…ä¸­æ˜¾ç¤ºIPä½ç½®"><i class="fas fa-crosshairs"></i></button>
    <button class="map-btn" id="center-geo" title="å±…ä¸­æ˜¾ç¤ºå®é™…ä½ç½®"><i class="fas fa-user"></i></button>
    <button class="map-btn" id="toggle-view" title="åˆ‡æ¢åœ°å›¾æ ·å¼"><i class="fas fa-layer-group"></i></button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const ipElement = document.getElementById('ip');
    const ipLocationElement = document.getElementById('ip-location');
    const geoLocationElement = document.getElementById('geo-location');
    const ipDetailsElement = document.getElementById('ip-details');
    const ipLocationDetailsElement = document.getElementById('ip-location-details');
    const geoLocationDetailsElement = document.getElementById('geo-location-details');
    
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([20, 0], 2);

    // åœ°å›¾å›¾å±‚é…ç½®
    const mapLayers = {
      street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© <a href="https://www.esri.com/">Esri</a>',
        maxZoom: 19
      }),
      terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://opentopomap.org">OpenTopoMap</a>',
        maxZoom: 17
      })
    };

    let currentLayer = 'street';
    mapLayers[currentLayer].addTo(map);

    let ipMarker, geoMarker;
    let ipData = null;
    let geoData = null;

    // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
    function createCustomIcon(color, symbol) {
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          background-color: ${color};
          border: 3px solid white;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          font-size: 14px;
          color: white;
          font-weight: bold;
        ">${symbol}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
      });
    }

    // æ ¼å¼åŒ–ä½ç½®ä¿¡æ¯
    function formatLocation(data) {
      const parts = [];
      if (data.city) parts.push(data.city);
      if (data.regionName) parts.push(data.regionName);
      if (data.country) parts.push(data.country);
      return parts.join(', ');
    }

    // æ›´æ–°UIçŠ¶æ€
    function updateStatus(element, status, details = '') {
      element.innerHTML = status;
      if (details && element.nextElementSibling) {
        element.nextElementSibling.textContent = details;
      }
    }

    // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
    function showSuccess(element) {
      element.classList.add('status-success');
    }

    // 1. è·å–å…¬ç½‘IPå’Œå½’å±åœ°ä¿¡æ¯
    async function fetchIPInfo() {
      try {
        const ipResponse = await fetch("https://api.ipify.org?format=json");
        const { ip } = await ipResponse.json();
        
        updateStatus(ipElement, ip, 'IPåœ°å€è·å–æˆåŠŸ');
        
        const locationResponse = await fetch(`https://ip-api.com/json/${ip}?lang=zh-CN&fields=status,message,country,regionName,city,zip,lat,lon,timezone,isp,org,as,query`);
        const data = await locationResponse.json();
        
        if (data.status === "success") {
          ipData = data;
          
          const locationText = formatLocation(data);
          const ispInfo = `${data.isp}${data.org && data.org !== data.isp ? ` (${data.org})` : ''}`;
          
          updateStatus(ipLocationElement, locationText, ispInfo);
          
          const timezone = data.timezone ? `æ—¶åŒº: ${data.timezone}` : '';
          const zipCode = data.zip ? `é‚®ç¼–: ${data.zip}` : '';
          ipLocationDetailsElement.textContent = [timezone, zipCode].filter(Boolean).join(' | ');
          
          // æ·»åŠ IPä½ç½®æ ‡è®°
          ipMarker = L.marker([data.lat, data.lon], {
            icon: createCustomIcon('#3b82f6', 'ğŸ“¡')
          }).addTo(map);
          
          ipMarker.bindPopup(`
            <div style="min-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: #3b82f6;">ğŸ“¡ IPå½’å±åœ°</h4>
              <p style="margin: 4px 0;"><strong>IPåœ°å€:</strong> ${data.query}</p>
              <p style="margin: 4px 0;"><strong>ä½ç½®:</strong> ${locationText}</p>
              <p style="margin: 4px 0;"><strong>ISP:</strong> ${data.isp}</p>
              ${data.org !== data.isp ? `<p style="margin: 4px 0;"><strong>ç»„ç»‡:</strong> ${data.org}</p>` : ''}
              <p style="margin: 4px 0;"><strong>åæ ‡:</strong> ${data.lat.toFixed(5)}, ${data.lon.toFixed(5)}</p>
            </div>
          `);
          
          map.setView([data.lat, data.lon], 10);
        } else {
          throw new Error(data.message || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (error) {
        console.error('IPæŸ¥è¯¢å¤±è´¥:', error);
        updateStatus(ipElement, 'è·å–å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        updateStatus(ipLocationElement, 'æŸ¥è¯¢å¤±è´¥', error.message);
      }
    }

    // 2. è·å–å®é™…åœ°ç†ä½ç½®
    function fetchGeolocation() {
      if (!navigator.geolocation) {
        updateStatus(geoLocationElement, 'ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
        updateStatus(geoLocationDetailsElement, 'è¯·ä½¿ç”¨æ”¯æŒåœ°ç†ä½ç½®çš„æµè§ˆå™¨');
        return;
      }

      updateStatus(geoLocationElement, 'ç­‰å¾…æˆæƒ...', 'æ­£åœ¨è¯·æ±‚ä½ç½®æƒé™');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude, accuracy, altitude, altitudeAccuracy, heading, speed } = position.coords;
          geoData = { lat: latitude, lon: longitude, accuracy };
          
          const coordText = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          const accuracyText = accuracy ? `ç²¾åº¦: Â±${accuracy.toFixed(0)}ç±³` : '';
          
          updateStatus(geoLocationElement, coordText, accuracyText);
          
          const details = [];
          if (altitude) details.push(`æµ·æ‹”: ${altitude.toFixed(0)}ç±³`);
          if (altitudeAccuracy) details.push(`æµ·æ‹”ç²¾åº¦: Â±${altitudeAccuracy.toFixed(0)}ç±³`);
          if (speed) details.push(`é€Ÿåº¦: ${(speed * 3.6).toFixed(1)} km/h`);
          
          geoLocationDetailsElement.textContent = details.join(' | ');
          
          // æ·»åŠ å®é™…ä½ç½®æ ‡è®°
          geoMarker = L.marker([latitude, longitude], {
            icon: createCustomIcon('#10b981', 'ğŸ‘¤')
          }).addTo(map);
          
          geoMarker.bindPopup(`
            <div style="min-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: #10b981;">ğŸ‘¤ æ‚¨çš„å®é™…ä½ç½®</h4>
              <p style="margin: 4px 0;"><strong>åæ ‡:</strong> ${coordText}</p>
              <p style="margin: 4px 0;"><strong>ç²¾åº¦:</strong> Â±${accuracy.toFixed(0)}ç±³</p>
              ${altitude ? `<p style="margin: 4px 0;"><strong>æµ·æ‹”:</strong> ${altitude.toFixed(0)}ç±³</p>` : ''}
              ${speed ? `<p style="margin: 4px 0;"><strong>é€Ÿåº¦:</strong> ${(speed * 3.6).toFixed(1)} km/h</p>` : ''}
            </div>
          `);
          
          // æ·»åŠ ç²¾åº¦åœ†åœˆ
          L.circle([latitude, longitude], {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.1,
            radius: accuracy
          }).addTo(map);
          
          // å¦‚æœä¸¤ä¸ªä½ç½®éƒ½æœ‰ï¼Œè°ƒæ•´è§†å›¾æ˜¾ç¤ºä¸¤ä¸ªæ ‡è®°
          if (ipData) {
            const bounds = L.latLngBounds([
              [ipData.lat, ipData.lon],
              [latitude, longitude]
            ]);
            map.fitBounds(bounds, { padding: [50, 50] });
          } else {
            map.setView([latitude, longitude], 15);
          }
        },
        (error) => {
          let message = 'è·å–ä½ç½®å¤±è´¥';
          let details = '';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              message = 'ä½ç½®æƒé™è¢«æ‹’ç»';
              details = 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®';
              break;
            case error.POSITION_UNAVAILABLE:
              message = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
              details = 'è¯·æ£€æŸ¥è®¾å¤‡å®šä½æœåŠ¡æ˜¯å¦å¼€å¯';
              break;
            case error.TIMEOUT:
              message = 'è·å–ä½ç½®è¶…æ—¶';
              details = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•';
              break;
            default:
              message = 'æœªçŸ¥é”™è¯¯';
              details = error.message;
          }
          
          updateStatus(geoLocationElement, message, details);
          updateStatus(geoLocationDetailsElement, 'æ— æ³•è·å–ç²¾ç¡®ä½ç½®ä¿¡æ¯');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        }
      );
    }

    // åœ°å›¾æ§åˆ¶åŠŸèƒ½
    document.getElementById('center-ip').addEventListener('click', () => {
      if (ipData) {
        map.setView([ipData.lat, ipData.lon], 12);
        if (ipMarker) ipMarker.openPopup();
      }
    });

    document.getElementById('center-geo').addEventListener('click', () => {
      if (geoData) {
        map.setView([geoData.lat, geoData.lon], 15);
        if (geoMarker) geoMarker.openPopup();
      }
    });

    document.getElementById('toggle-view').addEventListener('click', () => {
      const layers = ['street', 'satellite', 'terrain'];
      const currentIndex = layers.indexOf(currentLayer);
      const nextIndex = (currentIndex + 1) % layers.length;
      const nextLayer = layers[nextIndex];
      
      map.removeLayer(mapLayers[currentLayer]);
      mapLayers[nextLayer].addTo(map);
      currentLayer = nextLayer;
      
      // æ›´æ–°æŒ‰é’®å›¾æ ‡
      const icons = {
        street: 'fas fa-map',
        satellite: 'fas fa-satellite',
        terrain: 'fas fa-mountain'
      };
      document.getElementById('toggle-view').innerHTML = `<i class="${icons[nextLayer]}"></i>`;
    });

    // åˆå§‹åŒ–
    fetchIPInfo();
    fetchGeolocation();

    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case '1':
            e.preventDefault();
            document.getElementById('center-ip').click();
            break;
          case '2':
            e.preventDefault();
            document.getElementById('center-geo').click();
            break;
          case 't':
            e.preventDefault();
            document.getElementById('toggle-view').click();
            break;
        }
      }
    });
  </script>
</body>
</html>
